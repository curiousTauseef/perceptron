#include "learn.h"
#include <iostream>
#include <fstream>
#include <cstdlib>

using namespace std;

Learn::Learn(unsigned int stimulusct, unsigned int resultct)
{
  stimct=stimulusct+1;  // include one for bias
  resct=resultct;
  weights=new float *[resct];
  for (unsigned int i=0;i<resct;i++) weights[i]=new float[stimct];
  result=new float[resct];
  _stim=new float[stimct];
  _stim[stimulusct]=1.0; // last element is always 1
  init();
}

Learn::~Learn()
{
  for (unsigned int i=0;i<resct;i++) delete [] weights[i];
  delete [] weights;
  delete [] result;
}

void Learn::set_stim(float *s)
{
  for (unsigned int i=0;i<stimct-1;i++) _stim[i]=s[i];
}
  

int Learn::init(void)
{
  unsigned i, j;
  threshold=1.0f;
  for (i=0;i<resct;i++)
    for (j=0;j<stimct;j++)
      weights[i][j]=0.0f;
  return 0;
}

int Learn::train(float *stim, unsigned int _result, float wt)
{
  unsigned i,j;
  unsigned int v=fetch(stim);
  int notneeded=1;
  for (i=0;i<resct&&(notneeded==1);i++)
    {
      if (i==_result && v<threshold)  notneeded=0;
      if (i!=_result && v>=threshold) notneeded=0;
    }
  if (v!=_result) notneeded=0;
  if (notneeded) return 0;
  set_stim(stim);
  if (wt==0) wt=1.0;
  for (i=0;i<resct;i++)
    {
      float w=wt;
      if (i==_result && result[i]>=threshold) continue;
      if (i!=_result &&  result[i]<threshold) continue;
      if (i!=_result) w=-w;
      for (j=0;j<stimct;j++)
	{
	  weights[i][j]+=w*_stim[j];
	}
    }
  return 0;
}

unsigned int Learn::fetch(float *stim)
{
  unsigned i,j;
  unsigned int nomax=1;
  unsigned int maxindex=0;
  float maxval;
  set_stim(stim);
  for (i=0;i<resct;i++)
    {
      result[i]=0.0f;
      for (j=0;j<stimct;j++)
	{
	  result[i]+=weights[i][j]*_stim[j];
	}
      if (nomax || result[i]>maxval)
	{
	  nomax=0;
	  maxindex=i;
	  maxval=result[i];
	}
    }
  return maxindex;
}

int Learn::load(const char *fn)
{
  unsigned i,j;
  ifstream ifile(fn);
  if (ifile.is_open())
    {
      ifile>>threshold;
      for (i=0;i<resct;i++)
	for (j=0;j<stimct;j++)
	  ifile>>weights[i][j];
    }
  ifile.close();
  return 0;
}


int Learn::save(const char *fn)
{
  unsigned i,j;
  ofstream ofile(fn);
  if (ofile.is_open())
    {
      ofile<<threshold<<" ";
      for (i=0;i<resct;i++)
	for (j=0;j<stimct;j++)
	  ofile<<weights[i][j]<<" ";
      ofile<<endl;
    }
  ofile.close();
  return 0;

}



void Learn::dump(void)
{
  unsigned i,j;
  cout<<"Stimct="<<stimct<<endl;
  cout<<"Resct="<<resct<<endl;
  cout<<"Threshold="<<threshold<<endl;
  cout<<"Weights\n";
  for (j=0;j<stimct;j++)
    {
    for (i=0;i<resct;i++)
      cout<<weights[i][j]<<"\t";
    cout<<endl;
    }
  cout<<"Results\n";
  for (j=0;j<resct;j++) cout<<result[j]<<"\t";
  cout<<endl;
}


